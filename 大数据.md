# 背景知识

## 范式建模

1. 第一范式（1NF）
   原子性：字段不可分。
   如10部华为手机应拆分为数量：10，品牌：华为，产品：手机
2. 第二范式（2NF）
   有主键，非主键字段依赖主键
3. 第三范式（3NF）
   非主键字段不能相互依赖
   ![Image-20240229164734136](./Images/Image-20240229164734136.png)
   严格的范式建模不允许数据、字段的重复，有利于数据的存储。

## 实体关系模型

实体：一行数据描述的主体对象；属性；关系：实体之间的关系等等
![Image-20240229171145311](./Images/Image-20240229171145311.png)
抽象实体→找出实体之间的关系→找出实体的属性→画出ER关系图
![Image-20240229171305426](./Images/Image-20240229171305426.png)

## 数据仓库

数据仓库的意义：

- 数据存储在互不兼容的系统重
- 关系型数据库一般不存储日志数据
- 决策者需要从商业角度观察数据，关系型数据库不适合

### 数据仓库

面向主题的、集成的、相对稳定的、反映历史变化的数据集合，其中的数据是有组织有结构的存储数据集合，用于对管理决策过程中的支持

**面向主题**

![Image-20240229195516189](./Images/Image-20240229195516189.png)

**集成**

![Image-20240229195619912](./Images/Image-20240229195619912.png)

**相对稳定**：可追溯

## 维度建模

主要面向分析场景的建模方式

维度建模中只存在两种表：事实表和维度表。

维度表有“主键唯一”的规则。

**事实表**由维度和度量组成，维度主要定性，度量主要定量
如地区ID、产品ID、月份、销售量、销售额这几个字段组成的事实表中，地区ID、产品ID等是为维度，销售量销售额为度量。
描述每一个地区的表为维度表。

事实表fact，维度表dIm，事实表和维度表关联形成宽表

### 星形模型

![Image-20240229201550158](./Images/Image-20240229201550158.png)

事实表和所有的维度表之间只存在一层关联

### 雪花模型

![Image-20240229201648969](./Images/Image-20240229201648969.png)

事实表和最底层的额维度表之间存在不止一层关联。

星型模型违范式建模，雪花模型范式建模，星型模型的数据分析效率比雪花模型的高。

### 星座模型

![Image-20240306104851467](./Images/Image-20240306104851467.png)



# 数据仓库分层设计

操作数据层（ODS）：直接存放业务系统抽取过来的数据，讲不同业务系统中的数据汇聚在一起。

数据仓库层（DW）：

​	数据明细层（DWD，Data Warehouse DetaIl）：保证数据质量，在ODS层的基础上对数据进行加工处理，提供更干净的数据

​	数据中间层（DWM，Data Warehouse MIddle）：对通用的诶度进行轻度聚合操作，计算相同的统计指标，方便复用

​	数据服务层（DWS，Data Warehouse ServIce）：快照主题业务组织主题宽表，用于OLAP分析

数据集市层（DM）：基于DW，整合汇总分析某一个主题的报表数据

**分层的意义**
	清晰的数据结构
	减少重复开发
	同意数据出口
	简化问题

**案例**

![Image-20240306181650791](./Images/Image-20240306181650791.png)



### 数据库与数据仓库的区别

数据库-OLTP：数据事务，数据仓库-OLAP：数据分析

| 功能       | 数据库                       | 数据仓库                       |
| ---------- | ---------------------------- | ------------------------------ |
| 数据范围   | 当前状态数据                 | 存储完整、反映历史变化的数据   |
| 数据变化   | 支持频繁的增删改查           | 可增加、查询，无更新、删除     |
| 应用场景   | 面向业务交易流程             | 面向分析、侧重决策分析         |
| 处理数据量 | 频繁、小批次、高并发、低延迟 | 非频繁、高吞吐、大批量、有延迟 |
| 设计理论   | 遵循数据库三范式，避免冗余   | 违范式，适当冗余               |
| 建模方式   | ER实体关系建模（范式建模）   | 范式建模+维度建模              |

### 大数据框架演变

#### 传统离线大数据架构

![Image-20240306193607641](./Images/Image-20240306193607641.png)

缺点：不能处理流式数据。搞不定实时数据的同步

#### lambda架构（离线处理+实时链路）

![Image-20240306223928371](./Images/Image-20240306223928371.png)

缺点：重复开发，缺乏代码、数据复用

#### 新lambda架构（离线数仓+实时数仓）

![Image-20240306224545017](./Images/Image-20240306224545017.png)

**缺点**：

1. 同样的需求需要开发两套一样的代码
2. 集群资源使用增多
3. 实时和离线结果的一致性不能保证
4. 随着数据量的增加离线数据仓库的T+处理需要的事件增加
5. 服务器存储占用大

#### Kappa架构（纯实时数仓）

![Image-20240306225311698](./Images/Image-20240306225311698.png)

**缺点**：

1. Kafka无法支持海量数据存储
2. Kafka无法支持高效的OLAP（不支持SQL查询）
3. 无法复用数据血缘管理体系
4. Kafka不支持数据的更新，只支持追加

### 架构选择

1. 公司刚上大数据或者公司业务没有实时场景→传统离线大数据架构
2. 公司离线业务多，实时业务少→离线数仓+实时链路的lambda架构
3. 公司离线业务和实时业务都比较多→离线数仓+实时数仓的Lambda架构
4. 公司实时业务多，离线相对少→Kappa纯试试数仓架构

### 混合架构

大多数实时业务采用Kappa架构，关键核心业务使用离线全量计算方式（Lambda）

#### 批流一体

1. 架构角度：架构支持批（离线）和流（实时）数据
2. 计算框架处理角度支持批和流
3. SQL支持角度上做到批流一体
4. 存储层面上做到批流一体（用一般离线数据和实时数据的存储是不一样的）。海量存储、数据更新等等

**→数据湖**

### 湖仓一体实时数仓架构

![Image-20240307142029329](./Images/Image-20240307142029329.png)

解决了这些问题：

- 支持存储统一
- 存储量大
- 任意分层都可以OLAP数据分析
- 复用同一套相同的血缘关系
- 实时数据更新

缺点：暂时发展不完善，存在比较多的BUG，速度不如Kafka

**Iceberg特点**

- 一种数据湖解决方案
- 格式表单表可以存储数十PB数据
- 支持实时、批量数据写入和读取，支持Spark、Flink计算引擎
- 支持SQL查询，支持增删改

### 实时数仓案例

**网易**

![Image-20240307142459689](./Images/Image-20240307142459689.png)

**顺丰**

顺丰主要业务流程

![Image-20240307142525850](./Images/Image-20240307142525850.png)

数据框架

![Image-20240307142748573](./Images/Image-20240307142748573.png)

**腾讯**

业务链：QQ音乐、腾讯广告、腾讯看点、小程序、视频号

原有架构

![Image-20240307143034283](./Images/Image-20240307143034283.png)

改造后架构

![Image-20240307143110915](./Images/Image-20240307143110915.png)

**滴滴**

自研的DDMQ支持SQL

![Image-20240307143146278](./Images/Image-20240307143146278.png)

